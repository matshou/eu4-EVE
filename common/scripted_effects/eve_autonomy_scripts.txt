
##################################
# EVE - Autonomy Scripts
##################################

# Called each month to check if country gained new territory.
# This will also update owner id for each new province
# @scope country
#
autonomy.check_for_change = {

	every_owned_province = {

		# Gained territory is uncolonized land
		# For some reason each time a province becomes uncolonized it
		# loses all custom data, so we need to set 'owner_id' again
		if = {
			limit = { is_var_less_than_val = { var = owner_id val = 1 } }
			autonomy.call_for_province_update = yes
			province.set_owner_id = yes
		}
		else = {
			# do this after handling uncolonized territory
			core.export_var_to_prev = { var = owner_id }

			if = {			# newly gained province
				limit = {
					owner = { is_var_not_equal_to = { var1 = output var2 = country_id } }
				}

				# Conquered another nation's capital province
				# Raising the flag to let the province ROOT scope know we've already updated autonomy.
				# Also don't update owner id, it will be used by province ROOT scope to find last province owner
				if = {
					limit = { has_province_modifier = capital_province }
					set_province_flag = conquered_capital
				}
				else = { province.set_owner_id = yes }		# update owner id

				clr_province_flag = distant_province		# don't try to remove modifier
				autonomy.call_for_province_update = yes		# call for an autonomy update
			}
		}
	}
}

# Call for autonomy update for scope province
# @scope province
#
autonomy.call_for_province_update = {

	set_province_flag = new_territory		# update only this province

	owner = {
		set_country_flag = territorial_change   	# call for autonomy update
		set_country_flag = gained_new_territory		# update only new territory
	}
}

# Set local autonomy floor for every owned distance based on distance from capital.
# Should ONLY be called from scope with ROOT a capital province
# @scope country
#
autonomy.update_distance = {

	if = {
		limit = { has_country_flag = gained_new_territory }
		every_owned_province = {
			limit = { has_province_flag = new_territory }
			autonomy.set_distance = yes
			clr_province_flag = new_territory
		}
		clr_country_flag = gained_new_territory
	}
	else = {
		every_owned_province = {
			autonomy.remove_distance_m = yes
			autonomy.set_distance = yes
		}
	}
	clr_country_flag = territorial_change
}

# Remove old distance modifier before applying new one
# Called when recalculating distance autonomy
# @scope province
#
autonomy.remove_distance_m = {

	if = {
		limit = { has_province_flag = distant_province }
		trigger_switch = {
			on_trigger = has_province_modifier
			prov_autonomy_from_dist_100 = { remove_province_modifier = prov_autonomy_from_dist_100 }
			prov_autonomy_from_dist_200 = { remove_province_modifier = prov_autonomy_from_dist_200 }
			prov_autonomy_from_dist_300 = { remove_province_modifier = prov_autonomy_from_dist_300 }
			prov_autonomy_from_dist_400 = { remove_province_modifier = prov_autonomy_from_dist_400 }
			prov_autonomy_from_dist_500 = { remove_province_modifier = prov_autonomy_from_dist_500 }
			prov_autonomy_from_dist_600 = { remove_province_modifier = prov_autonomy_from_dist_600 }
			prov_autonomy_from_dist_700 = { remove_province_modifier = prov_autonomy_from_dist_700 }
			prov_autonomy_from_dist_800 = { remove_province_modifier = prov_autonomy_from_dist_800 }
			prov_autonomy_from_dist_900 = { remove_province_modifier = prov_autonomy_from_dist_900 }
			prov_autonomy_from_dist_1000 = { remove_province_modifier = prov_autonomy_from_dist_1000 }
		}
	}
}

# Add autonomy modifiers based on province distance from capital
# Should ONLY be called from scope with ROOT a capital province
# @scope province
#
autonomy.set_distance = {

	# will be removed if the province is not distant
	set_province_flag = distant_province

	if = {
		limit = { province_distance = { who = ROOT distance = 1000 } }
		add_province_modifier = { name = "prov_autonomy_from_dist_1000" duration = -1 }
	}
	else_if = {
		limit = { province_distance = { who = ROOT distance = 900 } }
		add_province_modifier = { name = "prov_autonomy_from_dist_900" duration = -1 }
	}
	else_if = {
		limit = { province_distance = { who = ROOT distance = 800 } }
		add_province_modifier = { name = "prov_autonomy_from_dist_800" duration = -1 }
	}
	else_if = {
		limit = { province_distance = { who = ROOT distance = 700 } }
		add_province_modifier = { name = "prov_autonomy_from_dist_700" duration = -1 }
	}
	else_if = {
		limit = { province_distance = { who = ROOT distance = 600 } }
		add_province_modifier = { name = "prov_autonomy_from_dist_600" duration = -1 }
	}
	else_if = {
		limit = { province_distance = { who = ROOT distance = 500 } }
		add_province_modifier = { name = "prov_autonomy_from_dist_500" duration = -1 }
	}
	else_if = {
		limit = { province_distance = { who = ROOT distance = 400 } }
		add_province_modifier = { name = "prov_autonomy_from_dist_400" duration = -1 }
	}
	else_if = {
		limit = { province_distance = { who = ROOT distance = 300 } }
		add_province_modifier = { name = "prov_autonomy_from_dist_300" duration = -1 }
	}
	else_if = {
		limit = { province_distance = { who = ROOT distance = 200 } }
		add_province_modifier = { name = "prov_autonomy_from_dist_200" duration = -1 }
	}
	else_if = {
		limit = { province_distance = { who = ROOT distance = 100 } }
		add_province_modifier = { name = "prov_autonomy_from_dist_100" duration = -1 }
	}
	# province is in the capital zone and shouldn't have a distance modifier
	else = { clr_province_flag = distant_province }
}
